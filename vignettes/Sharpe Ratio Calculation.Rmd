---
title: "Sharpe Ratio Calculation"
output: html_document
---

```{css, echo=FALSE}
.dt-colnames {
  color: #fcba03;
}
```

```{r setup, include = FALSE}
library(magrittr)
```

# Scoring for an example student
As discussed in the
[Scoring](https://gothic-hedge-society.github.io/fintech.trading.competition/articles/Scoring.html)
section, the Sharpe Ratio is an essential part of how traders are ranked in this
competition. Here, we walk through an example that explains how the Sharpe Ratio
would be calculated for an example contest participant.

### Matching up Calculations w/ Excel and Other Programs (a quick note)
As simple as it may seem, calculating logarithms can differ slightly (or
sometimes, significantly) depending on the precision of the program you use.
It's possible to get different answers for the same log calcs in Excel, R, and
Python, and the difference gets magnified when calculating GMRR.

Therefore, don't worry too much if you try to follow along this example and wind
up with numbers that differ slightly. For the purposes of fairness in the
competition, it only matters that we use the same program for everyone -- which,
in this case, is the *log*() function in R.

### What risk-free rate do we use?
The Competition lasts about 3 months, starting on Day 1. On that day, let's 
further suppose that we visited the USDT's website and found that the 3-month 
CMT rate was 0.04% (annualized).

Since there are 252 trading days in a year, we convert that rate to a trading
day basis by dividing by 252 (and by 100 because it's a percent):

Let's store that as a variable:
``` {r echo = FALSE, message = FALSE}
rf = 0.04/100/252
print(paste0("The risk-free rate is ", signif(rf*100, 4), "%/year."))
```

The Gothic Hedge Society (who runs the trading competition) reasons that on Day
1, all participants must decide if they're going to actively trade or if they're
just going to put all of their money into 3-month risk-free debt and cash out 
when the Competition ends. 

Since about half of the participants will *lose* money, that idea isn't as bad
as it might sound.

Regardless, for the duration of the Competition, the 'risk-free' rate would be 
taken to be the 0.04%/yr observed on Day 1. It will change during the 
competition, for sure, but if you had truly run the "base strategy" of buying
bonds and waiting it out, then your capital would be tied up all semester.

Therefore, the **0.04%/yr** CMT rate provided for 3 Month debt is the standard 
against which we'll be judging everyone's performance.

--> Now let's suppose some trading data for a hypothetical Contest participant.

### Example Trader's Data
Let's say that today's date is 23 March 2021, and a student has been
participating in the competition for seven days. 

Her end-of-day (EoD) portfolio balance and daily log returns are given below:

``` {r echo = FALSE, message = FALSE}
student_data <- tibble::tibble(
  "EoD Portfolio Balance"  = c(
    999950, 999890, 1000100, 1000050, 1000250, 1000075, 1000301
  ),
  "Port. Return (%/trd day)" = c(
    NA, 
    log(
      `EoD Portfolio Balance`[-1] / 
        `EoD Portfolio Balance`[-length(`EoD Portfolio Balance`)]
    )
  )*100
)
print(student_data)

```

The student's **daily portfolio returns** are the log returns of her daily
portfolio value. For example, on 18 March 2021, she started the day with
\$1,000,100.00 and ended with \$1,000,050.00 in total portfolio value. Therefore
her return for that day was:
```{r}
# 'log()' here is the natural log, not base 10.
paste0(round(log(1000050.00 / 1000100.00) * 100, 5), "%")
```

Note that there's no way to calculate a return on the very first day because
there's nothing to compare it to.

The student's overall **geometric mean return** $R_{p}$ is calculated as:
```{r}
# Note that here, I'm rounding the returns to 4 digits, so the final answer will
# differ slightly than the one reported in the table (and used for official
# scoring) due to this rounding error.
student_gmrr <- student_data %>%
  dplyr::select("Port. Return (%/trd day)") %>%
  dplyr::filter(!is.na(`Port. Return (%/trd day)`)) %>% 
  tibble::deframe() %>% {
    prod(1 + .)^(1/length(.)) - 1
  }

print(paste0(round(student_gmrr*100, digits = 4), "% per trading day"))

```

The student's **excess return** is
```{r}
student_excess_return <- student_gmrr - rf
  
print(paste0(round(student_excess_return*100, digits = 3), " %/trading day"))
```


The students **volatility of returns** $\sigma^{2}_{p}$ is the standard 
deviation of her portfolio returns:
```{r}
student_vol <- student_data %>%
  dplyr::select("Port. Return (%/trd day)") %>%
  dplyr::filter(!is.na(`Port. Return (%/trd day)`)) %>% 
  tibble::deframe() %>%
  sd()
  
print(paste0(round(student_vol*100, digits = 3), " %/trading day"))
```



Finally, we can calculate the Sharpe Ratio for this student.

\begin{align*}
{\tt Sharpe\ Ratio} = \frac{R_{p} - r_{f}}{\sigma^{2}_{p}} 
\end{align*}

#### Wherein:

\begin{align*}
R_{p} & {\sf: Portfolio\ Return} \\
r_{f} & {\sf: Risk\ free\ rate\ of\ return} \\
\sigma^{2}_{p} & {\sf: Volatility\ of\ portfolio\ return}
\end{align*}

## Her Sharpe is therefore:
```{r}
student_Sharpe <- (student_gmrr - rf) / student_vol
print(student_Sharpe)
```

We repeat this calculation every day for every trader in the Competition.
